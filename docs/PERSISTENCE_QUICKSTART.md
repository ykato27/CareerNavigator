# データ永続化機能 クイックスタートガイド

## 🚀 5分で始める永続化機能

### ステップ1: ログイン

1. Streamlitアプリを起動
   ```bash
   streamlit run streamlit_app.py
   ```

2. サイドバーの「ユーザー管理」セクションでログイン
   - ユーザー名を入力（例: `your_name`）
   - メールアドレスを入力（任意）
   - 「ログイン」ボタンをクリック

### ステップ2: データ読み込みとモデル学習

1. **データ読み込み**ページ
   - 6種類のCSVファイルをアップロード
   - 「データを読み込む」をクリック

2. **モデル学習**ページに移動
   - 学習オプションを選択
   - 「MLモデル学習を実行」をクリック
   - ✅ モデルが自動的に保存されます！

### ステップ3: 推薦実行

1. **推論**ページに移動
2. メンバーを選択
3. 推薦方法とパラメータを設定
4. 「推薦を実行」をクリック
   - ✅ 推薦結果が自動的に履歴として保存されます！

### ステップ4: 履歴確認

1. **履歴**ページに移動
2. 過去の推薦履歴が表示されます
   - 実行日時
   - 使用したパラメータ
   - 推薦結果の詳細
3. CSVでダウンロード可能

## 📊 データの永続性

### ✅ 保存されるもの

- ユーザーアカウント情報
- 学習済みMLモデル
- 推薦実行履歴（日時、パラメータ、結果）
- セッション状態

### ❌ 保存されないもの（ログインしていない場合）

- アップロードしたCSVデータ
- 学習したモデル
- 推薦結果

## 🔐 ログインのメリット

| 機能 | 未ログイン | ログイン済み |
|------|-----------|-------------|
| データ読み込み | ✅ | ✅ |
| モデル学習 | ✅ | ✅ |
| 推薦実行 | ✅ | ✅ |
| モデル保存 | ❌ | ✅ |
| 履歴保存 | ❌ | ✅ |
| 履歴閲覧 | ❌ | ✅ |
| ブラウザを閉じても保持 | ❌ | ✅ |

## 💡 使用例

### シナリオ1: 定期的な分析作業

```
1日目:
- ログイン
- データをアップロード
- モデルを学習（保存される）
- 複数メンバーの推薦を実行（履歴に保存）

2日目:
- 同じアカウントでログイン
- 昨日のモデルが自動的に利用可能
- 昨日の推薦履歴を確認
- 追加の推薦を実行
```

### シナリオ2: 複数の推薦方法の比較

```
- NMF推薦を実行 → 履歴に保存
- グラフベース推薦を実行 → 履歴に保存
- ハイブリッド推薦を実行 → 履歴に保存

履歴ページで3つの方法を比較：
- どの方法が最も推薦数が多いか
- 実行時間の違い
- 推薦内容の違い
```

### シナリオ3: チームでの利用

```
ユーザーA:
- 自分のアカウントでログイン
- 営業部門のメンバーを分析
- 履歴が保存される

ユーザーB:
- 別のアカウントでログイン
- 技術部門のメンバーを分析
- 履歴が保存される

→ 各ユーザーの履歴は個別に管理される
```

## 🗄️ データの場所

### データベースファイル

```
CareerNavigator/
├── career_navigator.db  ← すべてのデータ
├── models/              ← 保存されたモデルファイル
│   ├── nmf_xxxxx.joblib
│   ├── nmf_yyyyy.joblib
│   └── ...
```

### バックアップ

重要なデータを保護するため、定期的にバックアップを作成：

```bash
# バックアップ作成
cp career_navigator.db backup/career_navigator_$(date +%Y%m%d).db

# バックアップから復元
cp backup/career_navigator_20231215.db career_navigator.db
```

## ⚙️ 設定

### データベースパスの変更

環境変数で設定可能：

```python
import os
os.environ['CAREER_NAV_DB_PATH'] = '/path/to/your/database.db'
```

### モデル保存ディレクトリの変更

```python
from skillnote_recommendation.core.persistence import ModelStorage, DatabaseManager

db = DatabaseManager()
model_storage = ModelStorage(db, storage_dir='/path/to/models')
```

## 🔍 トラブルシューティング

### 問題: 履歴が表示されない

**確認事項**:
- ✅ ログインしているか？
- ✅ 推薦を実行したか？
- ✅ 正しいユーザーでログインしているか？

### 問題: モデルが読み込まれない

**確認事項**:
- ✅ `models/` ディレクトリが存在するか？
- ✅ ディスク容量は十分か？
- ✅ ファイルのアクセス権限は正しいか？

### 問題: データベースエラー

**解決策**:
```bash
# データベースの整合性チェック
sqlite3 career_navigator.db "PRAGMA integrity_check;"

# 問題がある場合は新しいデータベースを作成
mv career_navigator.db career_navigator.db.old
# アプリを再起動すると新しいDBが作成される
```

## 📈 次のステップ

1. **詳細ドキュメントを読む**: `docs/persistence.md`
2. **テストを実行する**: `pytest tests/test_persistence.py`
3. **カスタマイズする**: ユーザー設定、モデルパラメータなど

## 🎯 ベストプラクティス

### 推奨される使用パターン

1. **定期的なバックアップ**
   - 週1回はデータベースをバックアップ
   - 重要な分析前にもバックアップ

2. **意味のあるユーザー名**
   - 個人名や部署名を使用
   - チーム内で一貫性を保つ

3. **履歴の活用**
   - 定期的に履歴を確認
   - 推薦方法の効果を比較
   - パラメータチューニングの記録として利用

4. **モデルの管理**
   - 古いモデルは定期的に削除
   - 重要なモデルは説明を付けて保存

## 🤝 サポート

質問や問題がある場合：

1. `docs/persistence.md` を確認
2. テストを実行: `pytest tests/test_persistence.py -v`
3. ログを確認
4. 開発チームに問い合わせ

---

**始めましょう！** 上記のステップ1から始めて、データ永続化機能を体験してください。
