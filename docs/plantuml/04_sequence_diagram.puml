@startuml シーケンス図
!theme plain
skinparam backgroundColor #FFFFFF
skinparam sequenceArrowColor #4A90E2
skinparam sequenceLifeLineBorderColor #333333
skinparam sequenceParticipantBackgroundColor #E8F4F8
skinparam defaultFontName "Noto Sans CJK JP, IPAGothic, MS Gothic, sans-serif"

title CareerNavigator 因果推論推薦プロセス シーケンス図 v4.0.0

actor ユーザー as User
participant "React UI" as UI
participant "FastAPI" as API
participant "CausalGraphRecommender" as Causal
participant "DependencyAnalyzer" as DepAnalyzer
participant "KnowledgeGraph" as Graph
database "CSV Data" as Data

== 1. データアップロードフェーズ ==

User -> UI: CSVファイルをアップロード
activate UI
UI -> API: POST /api/upload\n(6種類のCSVファイル)
activate API
API -> Data: ファイルを保存
activate Data
Data --> API: 保存完了
deactivate Data
API --> UI: 200 OK
deactivate API
UI --> User: アップロード完了通知
deactivate UI

== 2. モデル学習フェーズ ==

User -> UI: 学習パラメータを設定\n(min_members, correlation_threshold, weight_mode)
activate UI
UI -> API: POST /api/train\n{params: TrainParams}
activate API

API -> Causal: train(data, params)
activate Causal

Causal -> Causal: DirectLiNGAMアルゴリズム実行
note right
  因果グラフ構築
  ・スキル間の因果関係を学習
  ・隣接行列を生成
end note

Causal -> DepAnalyzer: 依存関係分析
activate DepAnalyzer
DepAnalyzer -> DepAnalyzer: 因果グラフから依存関係抽出
DepAnalyzer --> Causal: 依存関係マップ
deactivate DepAnalyzer

Causal -> Graph: build_from_data(data)
activate Graph
Graph -> Graph: 知識グラフ構築
Graph --> Causal: グラフ構築完了
deactivate Graph

Causal --> API: 学習完了 (モデル保存)
deactivate Causal

API --> UI: 200 OK {model_info}
deactivate API
UI --> User: 学習完了通知\nモデル情報表示
deactivate UI

== 3. 推薦生成フェーズ ==

User -> UI: メンバーIDを入力\n推薦数を指定 (top_k)
activate UI

UI -> API: POST /api/recommend\n{member_code, top_k}
activate API

API -> Causal: recommend(member_code, top_k)
activate Causal

Causal -> Data: get_member_competences(member_code)
activate Data
Data --> Causal: 現在のスキルリスト
deactivate Data

Causal -> DepAnalyzer: analyze_dependencies(current_skills)
activate DepAnalyzer
DepAnalyzer --> Causal: 依存関係分析結果
deactivate DepAnalyzer

Causal -> Causal: 3軸スコアリング

note right of Causal
  **Readiness Score**
  前提スキルの充足率

  **Probability Score**
  習得確率（条件付き確率）

  **Utility Score**
  キャリア目標との関連性

  **Total Score**
  w1*Readiness + w2*Probability + w3*Utility
end note

Causal -> Causal: 因果的フィルタリング
note right
  ・因果的に不可能なパスを除外
  ・前提条件未達のスキルを除外
end note

Causal --> API: List[Recommendation]\n(3軸スコア付き)
deactivate Causal

API --> UI: 200 OK {recommendations}
deactivate API

UI -> UI: 推薦結果を可視化\n(テーブル・チャート)
UI --> User: 推薦結果を表示
deactivate UI

== 4. グラフ可視化フェーズ ==

User -> UI: グラフ可視化を要求
activate UI

UI -> API: POST /api/graph/ego\n{member_code, competence_code}
activate API

API -> Graph: visualize_ego_network(member_code, competence_code)
activate Graph
Graph -> Graph: エゴネットワーク生成\n(Pyvis)
Graph --> API: グラフHTML
deactivate Graph

API --> UI: 200 OK {graph_html}
deactivate API

UI --> User: インタラクティブグラフ表示
deactivate UI

== 5. 重み調整フェーズ (オプション) ==

User -> UI: 重みモードを選択\n(手動/自動最適化)
activate UI

alt 手動調整
  UI -> API: POST /api/update-weights\n{weights}
  activate API
  API -> Causal: update_weights(weights)
  activate Causal
  Causal --> API: 更新完了
  deactivate Causal
  API --> UI: 200 OK
  deactivate API

else 自動最適化 (Optuna)
  UI -> API: POST /api/optimize-weights\n{objective}
  activate API
  API -> Causal: optimize_weights(objective)
  activate Causal
  Causal -> Causal: ベイズ最適化実行
  note right
    Optunaによる
    ハイパーパラメータ最適化
  end note
  Causal --> API: 最適重み
  deactivate Causal
  API --> UI: 200 OK {optimized_weights}
  deactivate API
end

UI --> User: 重み更新完了通知
deactivate UI

note over User, Data
  因果推論推薦の特徴:
  1. LiNGAMによる因果グラフ構築
  2. 3軸スコアリング (Readiness/Probability/Utility)
  3. 因果的フィルタリング
  4. ベイズ最適化による重み調整
  5. インタラクティブなグラフ可視化
end note

@enduml
