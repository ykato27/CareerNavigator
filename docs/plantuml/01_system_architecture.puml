@startuml システムアーキテクチャ
!theme plain
skinparam backgroundColor #FFFFFF
skinparam rectangleBorderColor #333333
skinparam rectangleBackgroundColor #E8F4F8
skinparam arrowColor #4A90E2
skinparam defaultFontName "Noto Sans CJK JP, IPAGothic, MS Gothic, sans-serif"

title CareerNavigator システムアーキテクチャ（レイヤー構造） v3.0.0

package "プレゼンテーション層 (Presentation Layer)" #E3F2FD {
  package "Streamlit App (Main)" #BBDEFB {
    [メインページ\n(streamlit_app.py)] as MainPage
    [因果推論推薦\n(1_Causal_Recommendation.py)] as CausalPage
    [キャリアダッシュボード\n(2_Employee_Career_Dashboard.py)] as DashboardPage
    [組織スキルマップ\n(3_Organizational_Skill_Map.py)] as OrgPage
  }

  package "WebUI (React + FastAPI)" #BBDEFB {
    [Frontend (React)] as ReactApp
    [Backend API (FastAPI)] as FastAPI
  }

  ReactApp <--> FastAPI : REST API
}

package "アプリケーション層 (Application Layer)" #E8F5E9 {
  [ビジネスロジック] as BusinessLogic #C8E6C9
  [推薦オーケストレーター] as Orchestrator
  [評価システム] as Evaluation
  [ロールモデル検索] as RoleModel
  [データ品質監視] as DataQuality

  BusinessLogic -down-> Orchestrator
  BusinessLogic -down-> Evaluation
  BusinessLogic -down-> RoleModel
  BusinessLogic -down-> DataQuality
}

package "ドメイン層 (Domain Layer)" #FFF3E0 {
  package "因果推論モジュール (Causal)" #FFCCBC {
    [因果グラフ構築\n(LiNGAM)] as CausalGraph
    [3軸スコアリング\n(Readiness/Prob/Utility)] as Scoring
    [因果パス生成] as CausalPath
  }

  package "機械学習モジュール (ML)" #FFE0B2 {
    [ML推薦器\n(ml_recommender.py)] as MLRecommender
    [行列分解 (NMF)] as NMF
    [多様性再ランキング] as Diversity
  }

  package "グラフモジュール (Graph)" #FFCCBC {
    [知識グラフ構築] as KnowledgeGraph
    [ランダムウォーク (RWR)] as RandomWalk
    [ハイブリッド推薦器] as HybridRec
  }

  package "コアモジュール (Core)" #F3E5F5 {
    [データモデル] as Models
    [評価器] as Evaluator
    [参照者検索] as RefPersons
  }

  CausalGraph --> Scoring
  Scoring --> CausalPath
  
  MLRecommender --> NMF
  MLRecommender --> Diversity

  HybridRec --> RandomWalk
  HybridRec --> NMF
  HybridRec --> KnowledgeGraph

  MLRecommender --> Models
  HybridRec --> Models
  CausalPath --> Models
}

package "インフラストラクチャ層 (Infrastructure Layer)" #ECEFF1 {
  package "データ層" #CFD8DC {
    [データローダー] as DataLoader
    [データ変換器] as DataTransformer
    [データ検証器] as DataValidator
  }

  package "永続化層" #B0BEC5 {
    database "CSV Files" as CSV
    database "Models" as Models_Storage
  }

  package "共通基盤" #90A4AE {
    [設定管理 (Config)] as Config
    [構造化ログ] as Logging
    [エラーハンドラー] as ErrorHandler
  }

  DataLoader --> CSV
  DataTransformer --> DataLoader
}

' レイヤー間の依存関係
MainPage --> DataLoader
CausalPage --> CausalPath
DashboardPage --> CausalPath
DashboardPage --> RoleModel
OrgPage --> DataTransformer

FastAPI --> Orchestrator
FastAPI --> RoleModel

Orchestrator --> MLRecommender
Orchestrator --> HybridRec
Orchestrator --> CausalPath

note right of ReactApp
  モダンWeb UI
  ・React + TypeScript
  ・Vite
end note

note right of CausalGraph
  因果推論エンジン
  ・LiNGAMアルゴリズム
  ・スキル依存関係抽出
end note

legend right
  |<#E3F2FD> プレゼンテーション層 |
  |<#E8F5E9> アプリケーション層 |
  |<#FFF3E0> ドメイン層 |
  |<#ECEFF1> インフラストラクチャ層 |
endlegend

@enduml
