@startuml クラス図
!theme plain
skinparam backgroundColor #FFFFFF
skinparam classBackgroundColor #E8F4F8
skinparam classBorderColor #333333
skinparam arrowColor #4A90E2
skinparam defaultFontName "Noto Sans CJK JP, IPAGothic, MS Gothic, sans-serif"

title CareerNavigator 主要クラス図 v4.0.0

package "データモデル (core/models.py)" {
  class Member {
    + member_code: str
    + name: str
    + role: Optional[str]
    + grade: Optional[str]
    + department: Optional[str]
    + hire_date: Optional[str]
    --
    + __post_init__()
    + validate()
  }

  class Competence {
    + competence_code: str
    + name: str
    + competence_type: CompetenceType
    + category: str
    + description: Optional[str]
    + level: Optional[int]
    --
    + __post_init__()
    + validate()
  }

  enum CompetenceType {
    SKILL
    EDUCATION
    LICENSE
  }

  class MemberCompetence {
    + member_code: str
    + competence_code: str
    + level: int
    + acquired_date: Optional[str]
    --
    + __post_init__()
    + validate()
  }

  Member "1" -- "*" MemberCompetence : "取得"
  Competence "1" -- "*" MemberCompetence : "取得者"
  Competence -- CompetenceType : "タイプ"
}

package "因果推論エンジン (graph/causal)" {
  class CausalGraphRecommender {
    - lingam_model: DirectLiNGAM
    - dependency_analyzer: DependencyAnalyzer
    - weights: Dict[str, float]
    --
    + train(data: pd.DataFrame, params: TrainParams): void
    + recommend(member_code: str, top_k: int): List[Recommendation]
    + update_weights(weights: Dict[str, float]): void
    + optimize_weights(objective: str): Dict[str, float]
    + get_causal_graph(): nx.DiGraph
  }

  class DependencyAnalyzer {
    - adjacency_matrix: np.ndarray
    - competence_map: Dict
    --
    + analyze_dependencies(competence_code: str): Dict
    + get_prerequisites(competence_code: str): List[str]
    + get_dependents(competence_code: str): List[str]
    + compute_causal_path(from_code: str, to_code: str): List[str]
  }

  class CausalCareerPath {
    - causal_graph: nx.DiGraph
    - knowledge_graph: KnowledgeGraph
    --
    + generate_career_path(member_code: str, target_role: str): CareerPath
    + analyze_skill_progression(member_code: str): Dict
    + find_optimal_path(from_skills: List, to_skills: List): List
  }

  class Recommendation {
    + competence_code: str
    + competence_name: str
    + competence_type: CompetenceType
    + category: str
    + readiness_score: float
    + probability_score: float
    + utility_score: float
    + total_score: float
    + causal_reasoning: str
    --
    + __post_init__()
    + to_dict(): Dict
  }

  CausalGraphRecommender o-- DependencyAnalyzer
  CausalGraphRecommender ..> Recommendation : "生成"
  CausalCareerPath o-- CausalGraphRecommender
  Recommendation -- Competence : "推薦"
}

package "グラフコンポーネント" {
  class KnowledgeGraph {
    - graph: nx.DiGraph
    - node_attributes: Dict
    --
    + build_from_data(data: TransformedData): void
    + add_competence_node(competence: Competence): void
    + add_edge(source: str, target: str, weight: float): void
    + get_neighbors(node: str): List[str]
    + visualize(): Dict
  }

  CausalCareerPath o-- KnowledgeGraph
  KnowledgeGraph ..> Competence : "ノード"
}

package "データ処理" {
  class DataLoader {
    - data_dir: str
    --
    + load_members(): pd.DataFrame
    + load_competences(): pd.DataFrame
    + load_member_competences(): pd.DataFrame
    + load_all_data(): Dict
  }

  class DataTransformer {
    --
    + create_competence_master(raw_data: Dict): pd.DataFrame
    + create_member_competence(raw_data: Dict, competence_master: pd.DataFrame): pd.DataFrame
    + create_skill_matrix(member_competence: pd.DataFrame): pd.DataFrame
    + clean_members_data(raw_data: Dict): pd.DataFrame
  }
}

package "FastAPI モデル" {
  class TrainParams {
    + min_members: int
    + correlation_threshold: float
    + weight_mode: str
    + manual_weights: Optional[Dict]
  }

  class RecommendRequest {
    + member_code: str
    + top_k: int
  }

  class WeightUpdateRequest {
    + weights: Dict[str, float]
  }

  CausalGraphRecommender ..> TrainParams : "使用"
}

note top of Member
  メンバー（従業員）情報
  ・不変オブジェクト（frozen）
  ・バリデーション機能付き
end note

note top of Competence
  コンピテンシー（スキル・資格・教育）
  ・3種類のタイプ
  ・カテゴリ階層構造
end note

note top of CausalGraphRecommender
  因果推論推薦エンジン
  ・LiNGAM (DirectLiNGAM) による因果グラフ構築
  ・3軸スコアリング
    - Readiness: 準備完了度
    - Probability: 習得確率
    - Utility: 有用性
  ・ベイズ最適化 (Optuna) による重み調整
end note

note top of DependencyAnalyzer
  依存関係分析
  ・因果グラフから依存関係を抽出
  ・前提スキルの特定
  ・因果パスの計算
end note

@enduml
